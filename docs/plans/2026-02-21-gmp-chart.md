# Interactive 7D GMP Touch Chart Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a lightweight interactive 7-day GMP chart in IPO details that matches the reference behavior: straight line, touch crosshair/tooltip, green for profit, red for loss, and a dotted flat line when GMP is inactive.

**Architecture:** Keep the existing flow (`screen -> hook -> service -> apiClient`). Add only what is needed: stock ID mapping for the history endpoint, normalized GMP history fetch, a pure chart math utility (unit-tested), and one `react-native-svg` chart component. No new chart library.

**Tech Stack:** Expo React Native, TypeScript strict, react-native-svg (already present), Vitest unit tests.

---

**Execution notes:**
- Run in a dedicated worktree first (`@superpowers/using-git-worktrees`).
- Use strict TDD loops (`@superpowers/test-driven-development`).
- Verify before claiming done (`@superpowers/verification-before-completion`).
- Request review at the end (`@superpowers/requesting-code-review`).
- DRY + YAGNI: only 7D is functional now; `1M` and `ALL` are visual placeholders.

### Task 1: Add Contracts for Stock ID and GMP History

**Files:**
- Modify: `src/types/ipo.types.ts`
- Modify: `src/utils/dataTransformers.ts`
- Test: `tests/utils/data-transformers-gmp.test.ts`

**Step 1: Write the failing test**

```ts
import { describe, expect, it } from 'vitest'
import { transformIPOData } from '../../src/utils/dataTransformers'
import type { IPOWithGMP } from '../../src/types'

describe('transformIPOData for GMP chart', () => {
  it('maps backend stock_id to display stockId', () => {
    const input: IPOWithGMP = {
      id: 'ipo-1',
      stock_id: '2584',
      name: 'Demo IPO',
      company_code: 'DEMO',
      registrar: 'KFin',
      status: 'LIVE',
      strengths: [],
      risks: [],
      created_at: '2026-02-21T00:00:00.000Z',
      updated_at: '2026-02-21T00:00:00.000Z',
      gmp_value: 5,
    }

    const result = transformIPOData(input)
    expect(result.stockId).toBe('2584')
  })
})
```

**Step 2: Run test to verify it fails**

Run: `bun run test:unit -- tests/utils/data-transformers-gmp.test.ts`
Expected: FAIL because `DisplayIPO.stockId` does not exist and transformer does not map it.

**Step 3: Write minimal implementation**

```ts
// src/types/ipo.types.ts
export interface DisplayIPO {
  id: string
  stockId?: string
  // ...existing fields
}

export interface GMPHistoryRawPoint {
  date: string
  gmp_value?: number
  gmp?: number
}

export interface GMPHistoryPoint {
  date: string
  gmpValue: number
}

export interface GMPHistoryResponse {
  stock_id?: string
  history?: GMPHistoryRawPoint[]
}
```

```ts
// src/utils/dataTransformers.ts
const transformed: DisplayIPO = {
  id: ipo.id || '',
  stockId: ipo.stock_id || undefined,
  // ...existing mapping
}
```

**Step 4: Run test to verify it passes**

Run: `bun run test:unit -- tests/utils/data-transformers-gmp.test.ts`
Expected: PASS.

**Step 5: Commit**

```bash
git add tests/utils/data-transformers-gmp.test.ts src/types/ipo.types.ts src/utils/dataTransformers.ts
git commit -m "feat: add stockId and GMP history type contracts"
```

### Task 2: Add GMP History Service Method (7-Day Normalized)

**Files:**
- Modify: `src/services/ipoService.ts`
- Test: `tests/services/ipo-gmp-history.test.ts`

**Step 1: Write the failing test**

```ts
import { beforeEach, describe, expect, it, vi } from 'vitest'

const getMock = vi.fn()

vi.mock('../../src/services/api', () => ({
  apiClient: { get: getMock },
}))

import { ipoService } from '../../src/services/ipoService'

describe('ipoService.getGMPHistory', () => {
  beforeEach(() => getMock.mockReset())

  it('calls endpoint and returns sorted latest 7 points', async () => {
    getMock.mockResolvedValue({
      data: {
        success: true,
        data: {
          stock_id: '2584',
          history: [
            { date: '2026-02-14', gmp_value: 1 },
            { date: '2026-02-15', gmp_value: 2 },
            { date: '2026-02-16', gmp_value: 3 },
            { date: '2026-02-17', gmp_value: 4 },
            { date: '2026-02-18', gmp_value: 5 },
            { date: '2026-02-19', gmp_value: 6 },
            { date: '2026-02-20', gmp_value: 7 },
            { date: '2026-02-21', gmp_value: 8 },
          ],
        },
      },
    })

    const result = await ipoService.getGMPHistory('2584')
    expect(getMock).toHaveBeenCalledWith('/gmp/history/2584')
    expect(result).toHaveLength(7)
    expect(result[0]?.date).toBe('2026-02-15')
    expect(result[6]?.gmpValue).toBe(8)
  })

  it('returns [] for empty history', async () => {
    getMock.mockResolvedValue({ data: { success: true, data: { history: [] } } })
    await expect(ipoService.getGMPHistory('2584')).resolves.toEqual([])
  })
})
```

**Step 2: Run test to verify it fails**

Run: `bun run test:unit -- tests/services/ipo-gmp-history.test.ts`
Expected: FAIL because `getGMPHistory` is missing.

**Step 3: Write minimal implementation**

```ts
// src/services/ipoService.ts
import type { GMPHistoryPoint, GMPHistoryRawPoint, GMPHistoryResponse } from '../types'

const normalizeGMPHistory = (rows: GMPHistoryRawPoint[]): GMPHistoryPoint[] => {
  return rows
    .map((row) => ({
      date: row.date,
      gmpValue: Number(row.gmp_value ?? row.gmp ?? Number.NaN),
    }))
    .filter((row) => row.date && Number.isFinite(row.gmpValue))
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
    .slice(-7)
}

async getGMPHistory(stockId: string): Promise<GMPHistoryPoint[]> {
  const response = await apiClient.get<{ data: GMPHistoryResponse | GMPHistoryRawPoint[]; success: boolean }>(
    `/gmp/history/${stockId}`
  )

  const payload = response.data.data
  const rows = Array.isArray(payload) ? payload : payload?.history || []
  return normalizeGMPHistory(rows)
}
```

Also export it at the bottom of `ipoService.ts`:

```ts
export const {
  // ...existing exports
  getGMPHistory,
} = ipoService
```

**Step 4: Run test to verify it passes**

Run: `bun run test:unit -- tests/services/ipo-gmp-history.test.ts`
Expected: PASS.

**Step 5: Commit**

```bash
git add tests/services/ipo-gmp-history.test.ts src/services/ipoService.ts
git commit -m "feat: add normalized 7-day GMP history service"
```

### Task 3: Add Pure Chart Utility (Math + Touch Selection)

**Files:**
- Create: `src/utils/gmpChartModel.ts`
- Modify: `src/utils/index.ts`
- Test: `tests/utils/gmp-chart-model.test.ts`

**Step 1: Write the failing test**

```ts
import { describe, expect, it } from 'vitest'
import {
  buildGMPChartModel,
  formatGMPValue,
  getNearestPointIndex,
  getTrendSummary,
} from '../../src/utils/gmpChartModel'

const history = [
  { date: '2026-02-15', gmpValue: 1 },
  { date: '2026-02-16', gmpValue: 2 },
  { date: '2026-02-17', gmpValue: 5 },
  { date: '2026-02-18', gmpValue: 4 },
  { date: '2026-02-19', gmpValue: -2 },
  { date: '2026-02-20', gmpValue: -1 },
  { date: '2026-02-21', gmpValue: 3 },
]

describe('gmpChartModel', () => {
  it('creates straight path with 6 L-segments for 7 points', () => {
    const model = buildGMPChartModel(history, 320, 200)
    expect(model.path.startsWith('M ')).toBe(true)
    expect((model.path.match(/ L /g) || []).length).toBe(6)
  })

  it('returns nearest index for touch x', () => {
    const model = buildGMPChartModel(history, 320, 200)
    expect(getNearestPointIndex(model.points, model.points[3].x + 1)).toBe(3)
  })

  it('formats signed GMP value', () => {
    expect(formatGMPValue(5)).toBe('+Rs5')
    expect(formatGMPValue(-5)).toBe('-Rs5')
  })

  it('provides dotted empty baseline in no-data model', () => {
    const model = buildGMPChartModel([], 320, 200)
    expect(model.points).toHaveLength(0)
    expect(model.emptyLineY).toBe(100)
  })

  it('computes summary change from first to last', () => {
    const summary = getTrendSummary(history)
    expect(summary.latest).toBe(3)
    expect(summary.change).toBe(2)
  })
})
```

**Step 2: Run test to verify it fails**

Run: `bun run test:unit -- tests/utils/gmp-chart-model.test.ts`
Expected: FAIL because module does not exist.

**Step 3: Write minimal implementation**

```ts
// src/utils/gmpChartModel.ts
import type { GMPHistoryPoint } from '../types'

export interface ChartPoint {
  x: number
  y: number
  date: string
  gmpValue: number
}

export interface GMPChartModel {
  points: ChartPoint[]
  path: string
  rightTicks: number[]
  emptyLineY: number
}

export const buildGMPChartModel = (history: GMPHistoryPoint[], width: number, height: number): GMPChartModel => {
  const padTop = 16
  const padBottom = 26
  const padLeft = 12
  const padRight = 44
  const plotWidth = Math.max(width - padLeft - padRight, 1)
  const plotHeight = Math.max(height - padTop - padBottom, 1)

  if (!history.length) {
    return { points: [], path: '', rightTicks: [1, 0.5, 0, -0.5, -1], emptyLineY: Math.round(height / 2) }
  }

  const minRaw = Math.min(...history.map((h) => h.gmpValue))
  const maxRaw = Math.max(...history.map((h) => h.gmpValue))
  const spread = Math.max(maxRaw - minRaw, 1)
  const min = minRaw - spread * 0.15
  const max = maxRaw + spread * 0.15

  const points = history.map((h, i) => {
    const x = padLeft + (i / Math.max(history.length - 1, 1)) * plotWidth
    const y = padTop + ((max - h.gmpValue) / Math.max(max - min, 1)) * plotHeight
    return { x, y, date: h.date, gmpValue: h.gmpValue }
  })

  const path = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ')
  const rightTicks = [0, 1, 2, 3, 4].map((i) => Number((max - ((max - min) * i) / 4).toFixed(2)))

  return { points, path, rightTicks, emptyLineY: Math.round(height / 2) }
}

export const getNearestPointIndex = (points: ChartPoint[], touchX: number): number => {
  if (!points.length) return -1
  let best = 0
  let bestDistance = Number.POSITIVE_INFINITY
  points.forEach((p, i) => {
    const distance = Math.abs(p.x - touchX)
    if (distance < bestDistance) {
      bestDistance = distance
      best = i
    }
  })
  return best
}

export const formatGMPValue = (value: number): string => {
  const abs = Math.abs(Math.round(value))
  if (value > 0) return `+Rs${abs}`
  if (value < 0) return `-Rs${abs}`
  return 'Rs0'
}

export const getTrendSummary = (history: GMPHistoryPoint[]) => {
  if (!history.length) return { latest: 0, change: 0, changePercent: 0 }
  const first = history[0].gmpValue
  const latest = history[history.length - 1].gmpValue
  const change = latest - first
  const denominator = first === 0 ? 1 : Math.abs(first)
  return { latest, change, changePercent: (change / denominator) * 100 }
}
```

```ts
// src/utils/index.ts
export * from './gmpChartModel'
```

**Step 4: Run test to verify it passes**

Run: `bun run test:unit -- tests/utils/gmp-chart-model.test.ts`
Expected: PASS.

**Step 5: Commit**

```bash
git add tests/utils/gmp-chart-model.test.ts src/utils/gmpChartModel.ts src/utils/index.ts
git commit -m "feat: add lightweight GMP chart model utilities"
```

### Task 4: Build Interactive Chart Component (Reference Style)

**Files:**
- Create: `src/components/charts/GMPWeekInteractiveChart.tsx`
- Create: `src/components/charts/index.ts`
- Modify: `src/components/index.ts`
- Test: `manual UI verification`

**Step 1: Write the failing test/check**

```md
Manual failing check:
- IPO details currently has no dark reference-like chart block.
- No touch crosshair + tooltip behavior exists.
```

**Step 2: Run check to verify it fails**

Run: `bun start`
Expected: missing chart block and interactions.

**Step 3: Write minimal implementation**

```tsx
// src/components/charts/GMPWeekInteractiveChart.tsx
import React, { useCallback, useMemo, useState } from 'react'
import { GestureResponderEvent, StyleSheet, Text, View } from 'react-native'
import Svg, { Circle, Line, Path, Rect, Text as SvgText } from 'react-native-svg'
import { growwColors } from '../../design-system/tokens/colors'
import type { GMPHistoryPoint } from '../../types'
import { buildGMPChartModel, formatGMPValue, getNearestPointIndex, getTrendSummary } from '../../utils/gmpChartModel'

interface GMPWeekInteractiveChartProps {
  history: GMPHistoryPoint[]
  loading?: boolean
  disabledLabel?: string
}

const CHART_HEIGHT = 220

export function GMPWeekInteractiveChart({ history, loading = false, disabledLabel = 'GMP not active' }: GMPWeekInteractiveChartProps) {
  const [width, setWidth] = useState(0)
  const [activeIndex, setActiveIndex] = useState(history.length ? history.length - 1 : null)

  const model = useMemo(() => buildGMPChartModel(history, width, CHART_HEIGHT), [history, width])
  const summary = useMemo(() => getTrendSummary(history), [history])
  const trendColor = summary.latest >= 0 ? growwColors.success : growwColors.error
  const activePoint = activeIndex === null ? null : model.points[activeIndex] || null

  const onTouch = useCallback((event: GestureResponderEvent) => {
    if (!model.points.length) return
    const idx = getNearestPointIndex(model.points, event.nativeEvent.locationX)
    if (idx >= 0) setActiveIndex(idx)
  }, [model.points])

  return (
    <View style={styles.card}>
      <View style={styles.headerRow}>
        <View>
          <Text style={styles.latest}>{formatGMPValue(summary.latest)}</Text>
          <Text style={[styles.delta, { color: summary.change >= 0 ? growwColors.success : growwColors.error }]}>
            {formatGMPValue(summary.change)} ({summary.changePercent.toFixed(1)}%)
          </Text>
        </View>
        <View style={styles.rangeRow}>
          <Text style={styles.rangeActive}>7D</Text>
          <Text style={styles.rangeMuted}>1M</Text>
          <Text style={styles.rangeMuted}>ALL</Text>
        </View>
      </View>

      <View
        style={styles.touchLayer}
        onLayout={(e) => setWidth(e.nativeEvent.layout.width)}
        onStartShouldSetResponder={() => true}
        onMoveShouldSetResponder={() => true}
        onResponderGrant={onTouch}
        onResponderMove={onTouch}
      >
        <Svg width={width} height={CHART_HEIGHT}>
          {history.length > 0 && !loading && (
            <>
              <Path d={model.path} fill="none" stroke={trendColor} strokeWidth={2.5} />
              {activePoint && (
                <>
                  <Line x1={activePoint.x} y1={12} x2={activePoint.x} y2={CHART_HEIGHT - 26} stroke={growwColors.borderSubtle} strokeDasharray="4 4" />
                  <Line x1={12} y1={activePoint.y} x2={Math.max(width - 44, 12)} y2={activePoint.y} stroke={growwColors.borderSubtle} strokeDasharray="4 4" />
                  <Rect x={Math.max(width - 42, 0)} y={activePoint.y - 10} width={40} height={20} rx={4} fill={trendColor} />
                  <SvgText x={Math.max(width - 22, 0)} y={activePoint.y + 4} fontSize={10} fill={growwColors.textInverse} textAnchor="middle">
                    {formatGMPValue(activePoint.gmpValue)}
                  </SvgText>
                </>
              )}
              {model.points.map((point, idx) => (
                <Circle key={`${point.date}-${idx}`} cx={point.x} cy={point.y} r={activeIndex === idx ? 4 : 3} fill={point.gmpValue >= 0 ? growwColors.success : growwColors.error} />
              ))}
            </>
          )}

          {history.length === 0 && !loading && (
            <>
              <Line x1={12} y1={model.emptyLineY} x2={Math.max(width - 44, 12)} y2={model.emptyLineY} stroke={growwColors.borderSubtle} strokeDasharray="6 6" />
              <SvgText x={Math.max((width - 44) / 2, 16)} y={model.emptyLineY - 8} fontSize={11} fill="#C6CAD2" textAnchor="middle">
                {disabledLabel}
              </SvgText>
            </>
          )}
        </Svg>

        {activePoint && history.length > 0 && (
          <View style={[styles.tooltip, { left: Math.max(activePoint.x - 60, 8), top: Math.max(activePoint.y - 64, 8) }]}>
            <Text style={styles.tooltipDate}>{new Date(activePoint.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' })}</Text>
            <Text style={styles.tooltipValue}>{formatGMPValue(activePoint.gmpValue)}</Text>
          </View>
        )}
      </View>
    </View>
  )
}

const styles = StyleSheet.create({
  card: { backgroundColor: growwColors.darkSurface, borderRadius: 12, padding: 12 },
  headerRow: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 8 },
  latest: { color: growwColors.textInverse, fontSize: 28, fontWeight: '800' },
  delta: { marginTop: 2, fontSize: 13, fontWeight: '600' },
  rangeRow: { flexDirection: 'row', gap: 12 },
  rangeActive: { color: '#111827', backgroundColor: '#E5E7EB', paddingHorizontal: 10, paddingVertical: 6, borderRadius: 8, fontWeight: '700' },
  rangeMuted: { color: '#E5E7EB', opacity: 0.8, fontWeight: '700', paddingVertical: 6 },
  touchLayer: { position: 'relative', height: CHART_HEIGHT },
  tooltip: { position: 'absolute', backgroundColor: '#ECEFF3', borderRadius: 8, paddingHorizontal: 10, paddingVertical: 8 },
  tooltipDate: { color: '#111827', fontSize: 11 },
  tooltipValue: { color: '#111827', fontSize: 18, fontWeight: '800', marginTop: 2 },
})
```

```ts
// src/components/charts/index.ts
export { GMPWeekInteractiveChart } from './GMPWeekInteractiveChart'
```

```ts
// src/components/index.ts
export * from './charts'
```

**Step 4: Run check to verify it passes**

Run: `bun start`
Expected: dark chart card with straight line, touch crosshair, tooltip, and right-side selected value badge.

**Step 5: Commit**

```bash
git add src/components/charts/GMPWeekInteractiveChart.tsx src/components/charts/index.ts src/components/index.ts
git commit -m "feat: add interactive 7D GMP chart component"
```

### Task 5: Hook and Screen Integration in IPODetails

**Files:**
- Create: `src/hooks/useGMPHistory.ts`
- Modify: `src/hooks/index.ts`
- Modify: `src/screens/IPODetailsScreen.tsx`
- Test: `manual UI verification`

**Step 1: Write the failing test/check**

```md
Manual failing check:
- IPODetails screen does not fetch /gmp/history/:stockId.
- Chart section is still absent.
```

**Step 2: Run check to verify it fails**

Run: `bun start`
Expected: no GMP chart section in details screen.

**Step 3: Write minimal implementation**

```ts
// src/hooks/useGMPHistory.ts
import { useCallback, useEffect, useState } from 'react'
import { ipoService } from '../services/ipoService'
import type { GMPHistoryPoint } from '../types'

export const useGMPHistory = (stockId?: string) => {
  const [history, setHistory] = useState<GMPHistoryPoint[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const fetchHistory = useCallback(async () => {
    if (!stockId) {
      setHistory([])
      return
    }
    setLoading(true)
    setError(null)
    try {
      setHistory(await ipoService.getGMPHistory(stockId))
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to fetch GMP history')
      setHistory([])
    } finally {
      setLoading(false)
    }
  }, [stockId])

  useEffect(() => {
    fetchHistory()
  }, [fetchHistory])

  return { history, loading, error, refetch: fetchHistory }
}
```

```ts
// src/hooks/index.ts
export { useGMPHistory } from './useGMPHistory'
```

```tsx
// src/screens/IPODetailsScreen.tsx
import { GMPWeekInteractiveChart } from '../components/charts'
import { useGMPHistory, useIPODetails } from '../hooks'

// after `const ipo: DisplayIPO | null = fetchedIPO`
const stockId = ipo?.stockId || ipo?.id
const { history: gmpHistory, loading: gmpHistoryLoading } = useGMPHistory(stockId)

// add a new section after current GMP block
<View style={{ backgroundColor: 'white', padding: 20, marginBottom: 8 }}>
  <Text style={{ fontSize: 16, fontWeight: '700', color: growwColors.text, marginBottom: 12 }}>
    GMP Trend (7D)
  </Text>
  <GMPWeekInteractiveChart
    history={gmpHistory}
    loading={gmpHistoryLoading}
    disabledLabel={ipo?.gmp?.value === undefined ? 'GMP not active' : 'No GMP history yet'}
  />
</View>
```

**Step 4: Run check to verify it passes**

Run: `bun start`
Expected:
- New GMP chart section appears.
- Touch/drag selects nearest point and shows date + value.
- Green when latest GMP is positive; red when latest GMP is negative.
- Empty history shows straight dotted line with `GMP not active`.

**Step 5: Commit**

```bash
git add src/hooks/useGMPHistory.ts src/hooks/index.ts src/screens/IPODetailsScreen.tsx
git commit -m "feat: integrate interactive GMP chart into IPO details screen"
```

### Task 6: Verification Sweep

**Files:**
- Test: `tests/utils/data-transformers-gmp.test.ts`
- Test: `tests/services/ipo-gmp-history.test.ts`
- Test: `tests/utils/gmp-chart-model.test.ts`

**Step 1: Run targeted unit tests**

Run: `bun run test:unit -- tests/utils/data-transformers-gmp.test.ts tests/services/ipo-gmp-history.test.ts tests/utils/gmp-chart-model.test.ts`
Expected: PASS.

**Step 2: Run full unit tests**

Run: `bun run test:unit`
Expected: PASS (or document only pre-existing unrelated failures).

**Step 3: Manual acceptance checks on app**

Run: `bun start`
Verify:
- Endpoint uses `GET /gmp/history/:stockId` (example: `/gmp/history/2584`).
- Straight line path (no curve smoothing).
- Crosshair + tooltip update while touch moving.
- Right-side selected value badge aligns to active point.
- No-data state is exactly dotted straight line + `GMP not active`.

**Step 4: Commit final verification note**

```bash
git add docs/plans/2026-02-21-gmp-chart.md
git commit -m "docs: finalize plan for interactive 7D GMP touch chart"
```

**Step 5: Handoff**

```md
Ready for execution via @superpowers/executing-plans.
```

---

### Locked Product Behavior

- Y-axis and tooltip values are **GMP rupees** (`+Rs5`, `-Rs5`), not issue price values.
- Line is **straight** segment-to-segment (no smoothing).
- Touch anywhere on chart selects nearest point and updates tooltip.
- Main line color is based on latest GMP sign: **green profit**, **red loss**.
- If no data: render a **horizontal dotted line** and show **`GMP not active`**.

### API Assumption

- Base URL comes from existing `apiClient` config.
- Endpoint path implemented by service: `GET /gmp/history/:stockId`.
- Local example full URL: `http://localhost:8080/api/v1/gmp/history/2584`.
